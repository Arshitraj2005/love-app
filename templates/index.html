<!-- templates/index.html -->
<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Self-Destruct Chat</title>
  <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
  <style>
    body{font-family: Arial; max-width:700px;margin:30px auto}
    #messages{border:1px solid #ddd;padding:10px;min-height:120px}
    .msg{padding:8px;border-bottom:1px solid #eee}
    #lockOverlay{display:none;position:fixed;inset:0;background:#000000cc;color:white;align-items:center;justify-content:center}
  </style>
</head>
<body>
  <h2>Self-Destruct Chat (Demo)</h2>
  <div id="messages"></div>
  <div style="margin-top:10px">
    <input id="text" placeholder="Type message..." autocomplete="off" />
    <button id="send">Send</button>
  </div>
  <div style="margin-top:8px">
    <small>Type or move mouse to keep session alive. Inactivity of 60s clears messages.</small>
  </div>

<script>
  const socket = io();
  const room = 'main';
  const user = 'user_'+Math.floor(Math.random()*9999);

  const messagesDiv = document.getElementById('messages');
  const input = document.getElementById('text');
  const sendBtn = document.getElementById('send');

  socket.on('connect', ()=>{
    socket.emit('join', {room});
  });

  function renderMessages(list){
    messagesDiv.innerHTML = '';
    list.forEach(m=>{
      const el = document.createElement('div'); el.className='msg'; el.dataset.id=m.id;
      el.textContent = m.sender+': '+m.text + (m.seen? ' (seen)':'');
      messagesDiv.appendChild(el);
      // clicking marks seen
      el.addEventListener('click', ()=>{
        socket.emit('message_seen', {room, message_id: m.id});
      });
    });
  }

  socket.on('messages', (data)=>{
    renderMessages(data.messages || []);
  });

  socket.on('new_message', (data)=>{
    // Only one message will be shown because server clears old ones
    renderMessages([data.message]);
  });

  socket.on('messages_cleared', (data)=>{
    messagesDiv.innerHTML = '';
    console.log('cleared:', data);
  });

  sendBtn.onclick = ()=>{
    const t = input.value.trim(); if(!t) return;
    socket.emit('send_message', {room, text: t, sender: user});
    input.value = '';
  }

  // client-side activity reporting to server
  let activityDebounce = null;
  function reportActivity(){
    socket.emit('typing', {room, user});
    // throttle
    if(activityDebounce) return;
    activityDebounce = setTimeout(()=> activityDebounce = null, 1000);
  }

  ['mousemove','keydown','click'].forEach(ev=> window.addEventListener(ev, reportActivity));

  // when user clicks a message it will emit message_seen as above
</script>
</body>
</html>
